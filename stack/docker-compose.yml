---
services:
  genieacs:
    depends_on:
      - 'mongo'
    image: drumsergio/genieacs:latest
    restart: always
    container_name: "genieacs"
    environment:
      GENIEACS_UI_JWT_SECRET: changeme
      GENIEACS_CWMP_ACCESS_LOG_FILE: /var/log/genieacs/genieacs-cwmp-access.log
      GENIEACS_NBI_ACCESS_LOG_FILE: /var/log/genieacs/genieacs-nbi-access.log
      GENIEACS_FS_ACCESS_LOG_FILE: /var/log/genieacs/genieacs-fs-access.log
      GENIEACS_UI_ACCESS_LOG_FILE: /var/log/genieacs/genieacs-ui-access.log
      GENIEACS_DEBUG_FILE: /var/log/genieacs/genieacs-debug.yaml
      GENIEACS_EXT_DIR: /opt/genieacs/ext
      GENIEACS_MONGODB_CONNECTION_URL: mongodb://mongo/genieacs?authSource=admin
    ports:
      - "7547:7547"
      - "7557:7557"
      - "7567:7567"
      - "3000:3000"
    volumes:
      - opt_volume:/opt
    networks:
      - genieacs_network
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/3000' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mongo:
    image: mongo:4.4.6
    restart: always
    container_name: "mongo-genieacs"
    environment:
      # MONGO_INITDB_ROOT_USERNAME: userchange
      # MONGO_INITDB_ROOT_PASSWORD: passwordchange
      MONGO_DATA_DIR: /data/db
      MONGO_LOG_DIR: /var/log/mongodb
    volumes:
      - data_db:/data/db
      - data_configdb:/data/configdb
    expose:
      - 27017
    networks:
      - genieacs_network
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  genieacs-mcp:
    depends_on:
      - 'genieacs'
    image: drumsergio/genieacs-mcp:latest
    container_name: "genieacs-mcp"
    environment:
      ACS_URL: http://genieacs:7557
      ACS_USER: admin
      ACS_PASS: admin
    ports:
      - "8088:8080"
    networks:
      - genieacs_network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  syslog-ng:
    image: balabit/syslog-ng:latest
    container_name: syslog-ng
    ports:
      - "514:514/udp"
      - "514:514/tcp"
    volumes:
      - ./syslog-ng.conf:/etc/syslog-ng/syslog-ng.conf:ro
      - ${syslogs:-logs}:/var/log/syslog-ng
    restart: unless-stopped
    networks:
      - genieacs_network
    healthcheck:
      test: ["CMD", "syslog-ng-ctl", "stats"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  data_db:
  data_configdb:
  opt_volume:
  logs:

networks:
  genieacs_network:
